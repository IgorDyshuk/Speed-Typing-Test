import {showNotification} from "./notifications.js";


window.eng_words = 'in one good real one not school set they state high life consider on and not come what also for set point can want as while with of order child about school thing never hold find order each too between program work end you home place around while place problem end begin interest while public or where see time those increase interest be give end think seem small as both another a child same eye you between way do who into again good fact than under very head become real possible some write know however late each that with because that place nation only for each change form consider we would interest with world so order or run more open that large write turn never over open each over change still old take hold need give by consider line only leave while what set up number part form want against great problem can because head so first this here would course become help year first end want both fact public long word down also long for without new turn against the because write seem line interest call not if line thing what work people way may old consider leave hold want life between most place may if go who need fact such program where which end off child down change to from people high during people find to however into small new general it do that could old for last get another hand much eye great no work and with but good there last think can around use like number never since world need what we around part show new come seem while some and since still small these you general which seem will place come order form how about just also they with state late use both early too lead general seem there point take general seem few out like might under if ask while such interest feel word right again how about system such between late want fact up problem stand new say move a lead small however large public out by eye here over so be way use like say people work for since interest so face order school good not most run problem group run she late other problem real form what just high no man do under would to each too end point give number child through so this large see get form also all those course to work during about he plan still so like down he look down where course at who plan way so since come against he all who at world because while so few last these mean take house who old way large no first too now off would in this course present order home public school back own little about he develop of do over help day house stand present another by few come that down last or use say take would each even govern play around back under some line think she even when from do real problem between long as there school do as mean to all on other good may from might call world thing life turn of he look last problem after get show want need thing old other during be again develop come from consider the now number say life interest to system only group world same state school one problem between for turn run at very against eye must go both still all a as so after play eye little be those should out after which these both much house become both school this he real and may mean time by real number other as feel at end ask plan come turn by all head increase he present increase use stand after see order lead than system here ask in of look point little too without each for both but right we come world much own set we right off long those stand go both but under now must real general then before with much those at no of we only back these person plan from run new as own take early just increase only look open follow get that on system the mean plan man over it possible if most late line would first without real hand say turn point small set at in system however to be home show new again come under because about show face child know person large program how over could thing from out world while nation stand part run have look what many system order some one program you great could write day do he any also where child late face eye run still again on by as call high the must by late little mean never another seem to leave because for day against public long number word about after much need open change also'.split(' ');
window.ru_words = 'в одном хорошем реальном не школьном наборе они заявляют что высокая жизнь рассматривает и не приходит что также для установки точки может хотеть как в то время как с порядка ребенка о школе вещь никогда не держать найти порядок каждый тоже между программой работа конец вы дом место вокруг в то время как место проблема конец начать интерес в то время как публика или где видеть время те увеличить интерес быть дать конец думать казаться маленьким как и другой ребенок тот же глаз вы между путь делать кто в снова хороший факт чем под очень голова стать реальным возможным некоторые писать знать однако поздно каждый что с потому что что место нация только для каждого изменить форма рассмотреть мы бы интерес с миром так заказать или запустить больше открыть что большой писать повернуть никогда не над открыть каждый над изменить все еще старый взять держать нужно дать по рассмотреть линия только оставить в то время как что установить номер часть форма хотите против большой проблема может потому что голова так первый это здесь бы конечно стать помощь год первый конец хотите оба факт публика длинное слово вниз также долго для без новый повернуть против потому что писать казаться линия интерес звонить не если линия вещь что работа люди путь может старый рассмотреть оставить держать хочу жизнь между большинство место может если идти кто нужен факт такой программа где который конец от ребенка вниз изменить на от людей высокий во время люди найти к однако в маленький новый общий это сделать что мог старый для последнего получить другая рука много глаз большой нет работа и с но хороший там последний думаю может вокруг использовать как число никогда так как мир нужно что мы вокруг часть показать новый прийти кажется в то время как некоторые и так как все еще маленький эти вы общие которые кажутся разместят приходят заказ форма как насчет просто также они с состояние поздно использовать оба рано слишком вести общие кажутся там точка взять общие кажутся несколько из как может под если спросить в то время как такой интерес чувствовать слово правильно снова как насчет системы такой между поздно хотят факт вверх проблема стоять новый сказать переместить вести небольшой однако большой общественный из глаз здесь над так быть способ использовать как сказать люди работают для так как интерес так лицо заказ школа хороший не большинство запустить проблема группа запустить она поздно другой проблема реальный форма что просто высокий нет человек делать под бы к каждому слишком конец точка дать число ребенок через так этот большой видеть получить форму также все те курс работать во время около он план все еще так как вниз он смотрит вниз где курс в кто план путь так так как прийти против он все кто в мире потому что пока так мало последний эти означают взять дом кто старый путь большой нет первый тоже теперь выкл бы в этом курсе настоящий заказ домой государственная школа обратно собственный немного о он развиться сделать над помощью день дом стоять настоящий другой по несколько прийти что вниз последний или использовать сказать взять бы каждый даже управлять играть вокруг назад под линией думать она даже когда от делать реальная проблема между долго как там школа делать как значить для всех на других хорошо может от может называть мир вещь жизнь поворот он смотреть последний проблема после получить показать хотят нуждаться вещь старый другой во время быть снова развиваться прийти из рассмотреть сейчас число сказать жизнь интерес к системе только группа мир тот же штат школа одна проблема между для поворот запустить на очень против глаз должен идти оба все еще все как так после играть глаз немного быть те должны из после чего эти оба много дом стать оба школа это он реальный и может означать время реальным числом другой как чувствовать в конце спросить план прийти поворот по всем голова увеличить он присутствует увеличить использовать стоять после видеть заказ вести чем система здесь спросить в из смотреть точка мало тоже без каждого для обоих но правильно мы приходим мир много собственный набор мы сразу долго те стоят идти оба но под сейчас должен реальный общий тогда перед с много те в нет из мы только назад эти человек план из запустить новый как собственный взять рано просто увеличить только посмотреть открыть следовать получить что на системе средний план человек над это возможно если большинство поздно линия сначала без реальной руки сказать поворот точка небольшой установить в в система однако быть дома показать новый снова прийти под потому что о показать лицо ребенок знать человек большой программа как над мог вещь из нашего мира в то время как нация стоит часть беги иметь посмотри что многие система заказ одна программа ты великий мог написать день сделать он любой также где ребенок поздно лицо глаз беги еще снова на как зови высокий должен поздно немного значит никогда другой кажется оставить потому что для день против публичный длинное число слово о после много нужно открыть изменить также'.split(' ');
window.ukr_words = 'в одному хорошому справжньому не шкільному наборі вони заявляють про високе життя розглядають і не приходять що також для заданої точки можуть захотіти як у той час як із порядком дитиною про школу ніколи не дотримуйтеся порядку кожен також між програмою роботою кінцем домом місцем навколо поки місцем проблема кінець почати цікавитися в той час як громадськість або де бачити час ті збільшують інтерес бути давати кінець думати здаватись маленьким як обидва інші дитина те саме око ти між способом робити хто в знову хороший факт ніж під самою головою стати реальним можливо деякі пишуть знають однак пізно кожен що з тому що це місце нації лише для кожної форми зміни яку ми б зацікавили світ тож порядок або запуск більш відкритий що великий написати ніколи не перевертати відкривати змінювати все ще старий закріплюватися потрібно дати розглянути рядок лише залишити поки що налаштувати число частина форма хочу проти великої проблеми може тому що голова так що спочатку це тут курс стане допомогою рік перший кінець хочу обидва факт публічне довге слово вниз також хочу без нового повернути проти тому що написати здається рядок інтерес зателефонувати не якщо рядок річ що робота люди шлях може старий розглянути залишити утримувати хочуть життя між більшістю місце може якщо піти кому потрібен факт така програма де який кінець від дитини вниз змінюється на від людей високих під час людей знаходять однак в невеликий новий загальний це зробити це міг би старий нарешті отримати іншу руку багато очей чудово не працює і з але добре там останній думати може навколо використовувати як номер ніколи з тих пір як світ потребує того що ми навколо частина показуємо новий приходьте здається поки деякі і оскільки все ще малі ці ви загальні які здається відбудуться прийдуть накажуть як щодо просто також вони зі станом пізно використовують обидва рано занадто ведуть загальні здається є сенс беруть загальні здаються небагато як можливо під якщо запитати поки такий інтерес відчувати слово знову як щодо системи таке між пізно хочу факт вгору проблема стояти новий скажімо рухатися вперед невелика але велика публіка на око сюди отже використовуйте наприклад скажімо люди працюють оскільки інтерес так дивіться порядок школа добре не більшість біжить проблема група біжить вона спізнюється інша проблема справжня форма що просто високо ніхто не робить під щоб кожен також мав кінцеву точку дав номер дитині через так що цей великий дивіться отримати форму також усі ті звичайно щоб працювати під час про він планує все ще так як вниз він дивиться вниз де курс на хто планує шлях тому що виступають проти нього всі хто у світі тому що поки так мало триває ці підлі взяти будинок хто старий спосіб великий не перший теж зараз би в цьому курсі представити порядок домашньої державної школи назад власний небагато про він розвивати робити над допомога день будинок стояти присутні інший за кілька прийти що вниз останнім або використовувати сказати взяти б кожен навіть керувати грати назад під деякою лінією думати вона навіть коли від робити справжню проблему між поки є школа робити як злий все на іншому добре може від може називати світ річ життя поворот він дивитися остання проблема після отримати показати хочу потреба річ старе інше під час бути знову розвиватися прийти з розглянути зараз число сказати життя інтерес до системи лише група світ та сама державна школа одна проблема між для біг на повороті дуже проти ока повинен йти як і раніше так як після гри око мало бути тими які повинні вийти після чого ці обидва багато будинок стати обома школою це він справжній і може означати час дійсним числом інший як відчуття в кінці запитати план прийти до всіх голова збільшити він присутній збільшити використання стояти після дивитися порядок вести ніж система тут запитати дивитися трохи занадто без кожного для обох але правильно ми приходимо світ багато власний набір ми відразу довгі ті стоять ідуть обидва але під зараз повинен справжній загальний тоді раніше з багатьма тими без ми тільки підтримуємо ці люди планують від запуску новий як власний взяти рано просто збільшити тільки дивитися відкрито слідувати отримати це в системі підлий план людина над ним можливо якщо найбільш пізня лінія спочатку без справжньої руки скаже поворотний момент малий встановлений у системі однак бути вдома показати новий знову прийти під тому що приблизно показати обличчя дитина знати людину велика програма як можна щось із іншого світу поки нація стояти частково бігати дивитися скільки система замовляє якусь одну програму яку ти чудово міг би написати день чи він також де дитина пізно обличчя очі знову бігають на як виклик високий пізно мало означає ніколи інший здається залишити тому що протягом дня проти публічного довгого номера слово про після також потрібно відкрити зміни'.split(' ');
let words = window.eng_words
let wordsCount = words.length;
let gameTime = 30000
let prevRes = null
window.timer = null
window.gameStart = null
let focusTimer = null;
let idleBlinkTimer = null;
let language = "eng_words"
let time = 30
let customTimeConfirmed = false;

document.getElementById("game").addEventListener("focusout", () => {
  if (focusTimer) {
    clearTimeout(focusTimer);
  }

  focusTimer = setTimeout(() => {
    if (document.activeElement !== document.getElementById("game")) {
      document.getElementById("focus-error").style.opacity = "1";
      document.getElementById("focus-error").style.visibility = "visible";
      document.getElementById("words").style.filter = "blur(3px)";
    }
  }, 3000);
});

document.getElementById("game").addEventListener("focus", () => {
  if (focusTimer) {
    clearTimeout(focusTimer);
    focusTimer = null;
  }

  document.getElementById("focus-error").style.opacity = "0";
  document.getElementById("focus-error").style.visibility = "hidden";
  document.getElementById("words").style.filter = "blur(0)";
});

function addClass(el, name) {
  el.className += ' ' + name
}

function removeClass(el, name) {
  el.className = el.className.replace(name, '')

}

document.querySelectorAll('input[name="language"]').forEach(radio => {
  radio.addEventListener('change', (e) => {
    const gameElement = document.getElementById("game");

    language = null

    if (gameElement.classList.contains("over")) {
      e.target.checked = false;

      document.querySelector(`input[name="language"][value="${words === window.eng_words ? 'eng_words' : words === window.ru_words ? 'ru_words' : 'ukr_words'}"]`).checked = true;

      return;
    }

    const wordsContainer = document.getElementById("words");
    wordsContainer.classList.add("fade-out");
    const cursor = document.getElementById("cursor");
    cursor.style.animation = "none";
    cursor.style.opacity = "0";
    const restartBtn = document.getElementById("restart-btn");
    restartBtn.style.opacity = "0";

    wordsContainer.addEventListener("transitionend", function handleTransition() {
      wordsContainer.removeEventListener("transitionend", handleTransition);

      words = window[e.target.value];
      if (!words) return;
      wordsCount = words.length;

      language = e.target.value
      console.log("Selected language:", language)

      newGame();

      setTimeout(() => {
        wordsContainer.classList.remove("fade-out");
        cursor.style.opacity = "1";
        cursor.style.animation = "blink 1s infinite";
        restartBtn.style.opacity = "1";
      }, 10);

      const gameElement = document.getElementById("game");
      gameElement.focus();
    });
  });
});


function randomWord() {
  const randomIndex = Math.ceil(Math.random() * wordsCount);
  return words[randomIndex - 1];
}

function formatWord(word) {
  return `<div class="word"><span class="letter">${word.split('').join(`</span><span class="letter">`)}</span></div>`;

}

document.querySelectorAll('input[name="time"]').forEach(radio => {
  radio.addEventListener('change', (e) => {

    time = null

    gameTime = parseInt(e.target.value);

    time = gameTime / 1000
    console.log("Selected time:", time)

    document.getElementById("timer").innerHTML = (gameTime / 1000) + '';
    document.getElementById("custom-time").value = '';

    let customTime = document.getElementById("entered-time")
    customTime.innerHTML = '';
    customTime.style.width = '0';
    customTime.style.marginRight = '0';

    const gameElement = document.getElementById("game")
    gameElement.focus();
  });
});

document.addEventListener("visibilitychange", () => {
  if (!document.hidden) {
    document.getElementById("game").focus();
  }
});

document.querySelector('.search i').addEventListener('click', () => {
  document.querySelector('.search').classList.add('open');
  document.getElementById("custom-time").focus();
});

document.getElementById("custom-time").addEventListener('input', (e) => {
  let customTime = parseInt(e.target.value) * 1000;
  if (!isNaN(customTime) && customTime > 0) {
    gameTime = customTime;
    document.getElementById("timer").innerHTML = (gameTime / 1000) + '';
    document.querySelectorAll('input[name="time"]').forEach(radio => radio.checked = false);

    customTimeConfirmed = true;
  } else {
    gameTime = 30000;
    document.getElementById("timer").innerHTML = (gameTime / 1000) + '';
  }
});

document.addEventListener('click', (e) => {
  const searchBox = document.querySelector('.search');
  const customInput = document.getElementById('custom-time');
  if (!searchBox.contains(e.target) && customTimeConfirmed) {
    searchBox.classList.remove('open');
    let customTime = document.getElementById("entered-time")

    time = parseInt(customInput.value.trim())
    console.log("Selected custom time: ", time)

    customTime.innerHTML = (gameTime / 1000) + '';
    customTime.style.width = '100%';
    customTime.style.marginRight = '9px';

    customTimeConfirmed = false;
  }
});

function newGame() {
  const gameElement = document.getElementById("game")
  gameElement.focus();
  document.getElementById("words").innerHTML = '';
  for (let i = 0; i < 200; i++) {
    document.getElementById("words").innerHTML += formatWord(randomWord());
  }
  addClass(document.querySelector(".word"), "current");
  addClass(document.querySelector(".letter"), "current");
  window.timer = null
  document.getElementById("timer").innerHTML = (gameTime / 1000) + '';
}

function getWpm() {
  const words = [...document.querySelectorAll(".word")]
  const typedWords = words.filter(word => {
    return word.querySelector(".letter.correct, .letter.incorrect") !== null;
  });
  const correctWords = typedWords.filter(word => {
    const letters = [...word.children]
    const incorrectLetters = letters.filter(letter => letter.classList.contains('incorrect'))
    const correctLetters = letters.filter(letter => letter.classList.contains('correct'))
    return incorrectLetters.length === 0 && correctLetters.length === letters.length
  })

  const wpm = Math.floor(correctWords.length / gameTime * 60000)
  const accuracy = typedWords.length > 0 ? Math.floor((correctWords.length / typedWords.length) * 100) : 0;

  return {
    wpm: wpm,
    accuracy: accuracy,
  }
}

async function updateBestScore(score, accuracy, language, time) {
  try {
    const response = await fetch(`https://partly-popular-airedale.ngrok-free.app/update_best_score`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      credentials: 'include',
      body: JSON.stringify({
        score: score,
        accuracy: accuracy,
        language: language,
        time: time
      })
    });

    const bestResContainer = document.getElementById("best-score")
    bestResContainer.textContent = ''
    bestResContainer.classList.remove('login-error')

    if (!response.ok) {
      if (response.status === 401) {
        const errorMessage = await response.text()
        bestResContainer.textContent = errorMessage;
        bestResContainer.classList.add('login-error')

        document.querySelector('.nav-bar .profile').classList.add('animate__animated', 'animate__flash', 'animate__repeat-2')
        setTimeout(() => {
          document.querySelector('.nav-bar .profile').classList.remove('animate__animated', 'animate__flash', 'animate__repeat-2')
        }, 3000)

        throw new Error(errorMessage);
      }
      throw new Error(`Ошибка сервера: ${response.status} ${response.detail}`);
    }


    const data = await response.json();
    console.log(`Server response (${language}, ${time}):`, data);

    if (data.better === true) {
      bestResContainer.textContent = data.best_score;
      showNotification(data.message, "success")
    } else {
      bestResContainer.textContent = data.best_score;
    }

  } catch (error) {
    console.error("Ошибка при запросе:", error);
  }
}

async function update_completed_tests() {
  try {
    const response = await fetch(`https://partly-popular-airedale.ngrok-free.app/update_completed_tests`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      credentials: 'include',
    })

    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.detail);
    }

    const data = await response.json();
    console.log(data)
  } catch (error) {
    console.error(error);
  }
}

async function update_typing_duration(typing_duration) {
  try {
    const response = await fetch(`https://partly-popular-airedale.ngrok-free.app/update_typing_duration`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      credentials: 'include',
      body: JSON.stringify({
        typing_duration: typing_duration
      })
    })

    await response;
    console.log(`Typing duration updated on ${typing_duration} seconds`)
  } catch (error) {
    console.error("Error at typing duration updating: ", error);
  }
}

async function gameOver() {
  document.getElementById("timer").style.opacity = "0";
  document.getElementById("timer").style.visibility = "hidden";

  clearInterval(window.timer)
  addClass(document.getElementById("game"), 'over')
  const result = getWpm()
  document.getElementById("wpm").textContent = `${result.wpm}`;
  document.getElementById("accuracy").textContent = `${result.accuracy}%`;
  const comparison = document.getElementById("comparison")
  comparison.classList.remove('better')
  comparison.classList.remove('worse')
  if (prevRes === null) {
    comparison.textContent = "---"
  } else if (result.wpm > prevRes) {
    comparison.textContent = `improvement (${prevRes})`
    comparison.classList.add('better')
  } else if (result.wpm < prevRes) {
    comparison.textContent = `deterioration (${prevRes})`
    comparison.classList.add('worse')
  } else {
    comparison.classList.remove('better')
    comparison.classList.remove('worse')
    comparison.textContent = `same (${prevRes})`
  }

  document.querySelector(".nav-bar").style.opacity = "1";
  document.querySelector('.result-section').style.opacity = "1";

  prevRes = result.wpm;

  updateBestScore(result.wpm, result.accuracy, language, time).catch(console.error);
  update_completed_tests().catch(console.error);

  if (window.gameStart) {
    const typingDuration = Math.floor((Date.now() - window.gameStart) / 1000);
    update_typing_duration(typingDuration).catch(console.error);
  }

  window.gameStart = null;
}

async function restGameUI() {
  if (window.gameStart) {
    clearInterval(window.timer);
    window.timer = null;

    const typingDuration = Math.floor((Date.now() - window.gameStart) / 1000);
    requestAnimationFrame(() => {
      update_typing_duration(typingDuration);
    });
  }

  window.gameStart = null;

  const wordsContainer = document.getElementById("words");
  wordsContainer.style.marginTop = "0px";

  const cursor = document.getElementById("cursor");
  const firstLetter = document.querySelector(".word .letter");

  cursor.style.top = firstLetter.getBoundingClientRect().top + 4 + "px";
  cursor.style.left = firstLetter.getBoundingClientRect().left - 1 + "px";
  cursor.style.animation = "blink 1s infinite"

  const allWords = document.querySelectorAll(".word");
  allWords.forEach((word) => word.classList.remove("current"));

  const allLetters = document.querySelectorAll(".letter");
  allLetters.forEach((letter) =>
    letter.classList.remove("current", "correct", "incorrect", "extra")
  );

  const firstWord = document.querySelector(".word");
  firstWord.classList.add("current");
  firstWord.querySelector(".letter").classList.add("current");

  const gameElement = document.getElementById("game")
  gameElement.focus();

  document.getElementById("timer").innerHTML = (gameTime / 1000).toString();
  document.querySelector(".nav-bar").style.opacity = "1";
}


window.addEventListener('load', () => {
  const gameElement = document.getElementById("game")
  if (gameElement) {
    gameElement.focus()
  }
})

async function update_started_tests() {
  try {
    const response = await fetch(`https://partly-popular-airedale.ngrok-free.app/update_started_tests`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      credentials: 'include',
    })

    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.detail);
    }

    const data = await response.json();
    console.log(data)
  } catch (error) {
    console.error(error);
  }
}


document.addEventListener('keydown', handleKeyDown);

function handleKeyDown(e) {
  if (document.getElementById("game").classList.contains('over')) {
    return;
  }

  const allowKeys = /^[a-zA-Zа-яА-ЯёЁіІїЇєЄґҐ\s\b]$/;
  const isSpace = e.key === ' ';
  const isBackspace = e.key === 'Backspace';

  if (!window.timer && (isSpace || isBackspace)) {
    e.preventDefault();
    console.log('Игнор: Space или Backspace до начала игры');
    return;
  }

  if ((e.ctrlKey && isBackspace) || isBackspace) {
  } else if (e.altKey || e.metaKey || !allowKeys.test(e.key)) {
    e.preventDefault();
    return;
  }

  document.querySelector(".nav-bar").style.opacity = "0";
  document.querySelector('.result-section').style.opacity = "0";

  document.getElementById('timer').style.opacity = "1"
  document.getElementById('timer').style.visibility = "visible"

  const cursor = document.getElementById("cursor");
  cursor.style.animation = "none";

  if (idleBlinkTimer) {
    clearTimeout(idleBlinkTimer);
  }

  idleBlinkTimer = setTimeout(() => {
    cursor.style.animation = "blink1 1s infinite";
  }, 3000);

  const key = e.key
  const currentWord = document.querySelector(".word.current")
  const currenLetter = document.querySelector(".letter.current")
  const expected = currenLetter?.innerHTML || ' '
  const isLetter = key.length === 1 && key !== " "
  const isFirstLetter = currenLetter === currentWord.firstChild
  const isCtrlBackspace = key === 'Backspace' && e.ctrlKey

  if (document.querySelector('#game.over')) {
    return;
  }

  // console.log({key, expected})

  if (!window.timer && isLetter) {
    window.gameStart = (new Date()).getTime();
    document.getElementById("timer").innerHTML = (gameTime / 1000) + '';

    window.timer = setInterval(() => {
      const currentTime = (new Date()).getTime();
      const msPassed = currentTime - window.gameStart;
      const sPassed = Math.round(msPassed / 1000);
      const sLeft = (gameTime / 1000) - sPassed;
      if (sLeft <= 0) {
        gameOver().catch(err => {
          console.error("Error updating started tests:", err);
        });
        return;
      }
      document.getElementById("timer").innerHTML = sLeft + '';
    }, 1000);

    update_started_tests().catch(err => {
      console.error("Error updating started tests:", err);
    });
  }

  if (isLetter) {
    if (currenLetter) {
      addClass(currenLetter, key === expected ? 'correct' : 'incorrect')
      removeClass(currenLetter, "current")
      if (currenLetter.nextSibling) {
        addClass(currenLetter.nextSibling, "current")
      }
    } else {
      const extraLetter = document.createElement('span')
      extraLetter.innerHTML = key
      extraLetter.className = 'letter extra'
      currentWord.appendChild(extraLetter)
    }
  }

  if (isSpace) {
    if (!window.timer) {
      e.preventDefault()
      return
    }

    if (currenLetter && isFirstLetter) {
      return;
    }

    if (expected !== ' ') {
      const letterToInvalidate = [...document.querySelectorAll('.word.current .letter:not(.correct)')]
      letterToInvalidate.forEach(el => {
        addClass(el, "incorrect")
      })
    }

    const incorrectLetters = currentWord.querySelectorAll('.letter.incorrect, .letter.extra')
    if (incorrectLetters.length > 0) {
      addClass(currentWord, "incorrect")
    } else {
      removeClass(currentWord, "incorrect")
    }

    removeClass(currentWord, "current")
    addClass(currentWord.nextSibling, "current")
    if (currenLetter) {
      removeClass(currenLetter, "current")
    }
    addClass(currentWord.nextSibling.firstChild, "current")
  }

  if (isBackspace) {
    if (currenLetter && isFirstLetter) {
      const prevWord = currentWord.previousSibling
      const nextWordIncorrect = [...prevWord.querySelectorAll('.letter.incorrect, .letter.extra')]
      if (nextWordIncorrect.length === 0) {

      } else {
        removeClass(currentWord, "current")
        addClass(prevWord, "current")
        removeClass(currenLetter, "current")

        const prevWordExtra = [...prevWord.querySelectorAll('.letter.extra')]
        if (prevWordExtra.length > 0) {
          const lastExtraLetter = prevWordExtra[prevWordExtra.length - 1]
          addClass(lastExtraLetter, "current")
          lastExtraLetter.remove()
        } else {
          addClass(prevWord.lastChild, "current")
          removeClass(prevWord.lastChild, "incorrect")
          removeClass(prevWord.lastChild, "correct")
        }
        removeClass(prevWord, "incorrect")
      }
    }
    if (currenLetter && !isFirstLetter) {
      removeClass(currenLetter, "current")
      addClass(currenLetter.previousSibling, "current")
      removeClass(currenLetter.previousSibling, "correct")
      removeClass(currenLetter.previousSibling, "incorrect")
    }
    if (!currenLetter) {
      const extraLetters = [...currentWord.querySelectorAll('.letter.extra')]
      if (extraLetters.length > 0) {
        const lastExtraLetter = extraLetters[extraLetters.length - 1]
        lastExtraLetter.remove()
      } else {
        addClass(currentWord.lastChild, "current")
        removeClass(currentWord.lastChild, "correct")
        removeClass(currentWord.lastChild, "incorrect")
      }
    }
  }

  if (isCtrlBackspace) {
    e.preventDefault()

    if (currenLetter) {
      const letters = [...currentWord.children]
      const currentIndex = letters.indexOf(currenLetter)

      for (let i = 0; i < currentIndex; i++) {
        if (letters[i]) {
          removeClass(letters[i], "incorrect")
          removeClass(letters[i], "correct")
          removeClass(letters[i], "current")
        }
      }
      addClass(currentWord.firstChild, "current")
    } else {
      const allLetters = currentWord.querySelectorAll('.letter')
      allLetters.forEach(el => {
        removeClass(el, "incorrect")
        removeClass(el, "correct")
        removeClass(el, "current")
      })

      const extraLetters = currentWord.querySelectorAll('.letter.extra')
      extraLetters.forEach(el => {
        el.remove()
      })

      if (currentWord.firstChild) {
        addClass(currentWord.firstChild, "current")
      }
    }

    if (currenLetter && isFirstLetter) {
      const prevWord = currentWord.previousSibling
      const nextWordIncorrect = [...prevWord.querySelectorAll('.letter.incorrect, .letter.extra')]
      if (nextWordIncorrect.length === 0) {

      } else {
        removeClass(currentWord, "current")
        removeClass(currenLetter, "current")

        const allLettersPrev = prevWord.querySelectorAll('.letter')
        allLettersPrev.forEach(el => {
          removeClass(el, "incorrect")
          removeClass(el, "correct")
          removeClass(el, "current")
        })

        const extraLetters = prevWord.querySelectorAll('.letter.extra')
        extraLetters.forEach(el => {
          el.remove()
        })

        addClass(prevWord.firstChild, "current")

        removeClass(prevWord, "incorrect")
      }
    }
  }

  //move lines / words
  const nextWord = document.querySelector(".word.current")
  if (nextWord && nextWord.getBoundingClientRect().top > 300) {
    const words = document.getElementById('words')
    const margin = parseInt(words.style.marginTop || '0px')
    const wordHeight = (document.getElementById('game').getBoundingClientRect().height) / 3;
    words.style.marginTop = (margin - wordHeight) + 'px'
  }

  // move cursor
  const nextLetter = document.querySelector(".letter.current")

  if (nextLetter || nextWord) {
    const rect = (nextLetter || nextWord).getBoundingClientRect()
    cursor.style.top = rect.top + (rect.height / 2) - (cursor.offsetHeight / 2) + 'px'
    // console.log(rect.top + (rect.height / 2) - (cursor.offsetHeight / 2) + 'px')
    cursor.style.left = (nextLetter ? rect.left : rect.right) - 1 + "px"
  }
}

document.getElementById('restart-btn').addEventListener('click', () => {
  const wordsContainer = document.getElementById("words");
  const cursor = document.getElementById("cursor");

  wordsContainer.classList.add("fade-out");
  document.getElementById("timer").style.opacity = "0";
  document.getElementById("timer").style.visibility = "hidden";
  cursor.style.animation = "none";
  cursor.style.opacity = "0";

  document.getElementById("game").classList.remove("over");

  wordsContainer.addEventListener("transitionend", async function handleTransition() {
    wordsContainer.removeEventListener("transitionend", handleTransition);

    restGameUI().catch(error => {
      console.log(error)
    });
    newGame();

    // Маленькая задержка, чтобы убрать класс fade-out (и вернуть анимацию обратно)
    setTimeout(() => {
      wordsContainer.classList.remove("fade-out");
      cursor.style.opacity = "1";
      cursor.style.animation = "blink 1s infinite";
    }, 10);
  });
});

newGame();
